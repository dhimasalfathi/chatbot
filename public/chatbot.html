<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Bank Customer Service Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { 
      --bg:#0f172a; 
      --card:#111827; 
      --ink:#e5e7eb; 
      --muted:#9ca3af; 
      --ok:#22c55e; 
      --warn:#f59e0b; 
      --bad:#ef4444; 
      --accent:#38bdf8;
      --user-bg: #1e40af;
      --bot-bg: #374151;
    }
    * { box-sizing: border-box; }
    body { 
      margin:0; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; 
      background:var(--bg); 
      color:var(--ink);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    header { 
      padding:16px 20px; 
      border-bottom:1px solid #1f2937; 
      display:flex; 
      gap:12px; 
      align-items:center; 
      justify-content:space-between;
      background: var(--card);
    }
    header h1 { margin:0; font-size:18px; font-weight:600; letter-spacing:.2px; }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      height: calc(100vh - 120px);
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .message {
      display: flex;
      gap: 12px;
      max-width: 80%;
    }
    
    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    .message.bot {
      align-self: flex-start;
    }
    
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .message.user .message-avatar {
      background: var(--user-bg);
      color: white;
    }
    
    .message.bot .message-avatar {
      background: var(--bot-bg);
      color: white;
    }
    
    .message-content {
      background: var(--card);
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 12px 16px;
      position: relative;
    }
    
    .message.user .message-content {
      background: var(--user-bg);
      color: white;
    }
    
    .message-time {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    
    .suggestion-btn {
      background: #374151;
      color: var(--ink);
      border: 1px solid #4b5563;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .suggestion-btn:hover {
      background: var(--accent);
      color: #062330;
    }
    
    .chat-input-area {
      padding: 20px;
      border-top: 1px solid #1f2937;
      background: var(--card);
    }
    
    .chat-input-form {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    .chat-input {
      flex: 1;
      background: #0b1220;
      border: 1px solid #243244;
      color: var(--ink);
      border-radius: 12px;
      padding: 12px 16px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      font-family: inherit;
      outline: none;
    }
    
    .chat-send-btn {
      background: var(--accent);
      color: #062330;
      border: 0;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      min-width: 80px;
    }
    
    .chat-send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .status-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
    }
    
    .status-pill {
      padding: 4px 8px;
      border-radius: 12px;
      background: #0b1220;
      border: 1px solid #243244;
    }
    
    .typing-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      font-style: italic;
      color: var(--muted);
    }
    
    .typing-dots {
      display: flex;
      gap: 4px;
    }
    
    .typing-dots span {
      width: 6px;
      height: 6px;
      background: var(--muted);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 60%, 100% { opacity: 0.3; }
      30% { opacity: 1; }
    }
    
    .info-panel {
      background: #0b1220;
      border: 1px solid #243244;
      border-radius: 12px;
      padding: 12px;
      margin-top: 8px;
    }
    
    .info-panel h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--accent);
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 12px;
    }
    
    .info-item .label {
      color: var(--muted);
    }
    
    .info-item .value {
      color: var(--ink);
      font-weight: 500;
    }
    
    .scrollable {
      scrollbar-width: thin;
      scrollbar-color: #374151 transparent;
    }
    
    .scrollable::-webkit-scrollbar {
      width: 6px;
    }
    
    .scrollable::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .scrollable::-webkit-scrollbar-thumb {
      background: #374151;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ¤– Bank Customer Service Chatbot</h1>
    <div id="healthStatus" class="status-pill">
      <span id="healthText">Checking...</span>
    </div>
  </header>

  <div class="chat-container">
    <div class="status-bar">
      <div class="status-pill">
        Session: <span id="sessionId">-</span>
      </div>
      <div class="status-pill">
        Confidence: <span id="confidence">0%</span>
      </div>
      <div class="status-pill">
        Status: <span id="chatStatus">Ready</span>
      </div>
    </div>
    
    <div id="chatMessages" class="chat-messages scrollable">
      <!-- Messages will be inserted here -->
    </div>
    
    <div id="typingIndicator" class="typing-indicator">
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <span>Customer service sedang mengetik...</span>
    </div>
    
    <div class="chat-input-area">
      <form id="chatForm" class="chat-input-form">
        <textarea 
          id="chatInput" 
          class="chat-input" 
          placeholder="Ketik pesan Anda di sini..."
          rows="1"
        ></textarea>
        <button type="submit" id="sendBtn" class="chat-send-btn">Kirim</button>
      </form>
    </div>
  </div>

  <script>
    class ChatBot {
      constructor() {
        // Dynamic base URL detection
        this.baseUrl = this.detectBaseUrl();
        this.sessionId = null;
        this.isTyping = false;
        
        this.initElements();
        this.initEventListeners();
        this.checkHealth();
        this.startConversation();
      }
      
      detectBaseUrl() {
        // If running on same domain, use relative path
        if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
          // Production/GCP - use same origin
          const url = window.location.origin;
          console.log('ðŸŒ Production mode detected, using URL:', url);
          return url;
        } else {
          // Local development
          const url = 'http://localhost:5000';
          console.log('ðŸ”§ Local development mode detected, using URL:', url);
          return url;
        }
      }
      
      initElements() {
        console.log('ðŸš€ ChatBot initialized with baseUrl:', this.baseUrl);
        this.chatMessages = document.getElementById('chatMessages');
        this.chatInput = document.getElementById('chatInput');
        this.sendBtn = document.getElementById('sendBtn');
        this.typingIndicator = document.getElementById('typingIndicator');
        this.sessionIdEl = document.getElementById('sessionId');
        this.confidenceEl = document.getElementById('confidence');
        this.chatStatusEl = document.getElementById('chatStatus');
        this.healthStatusEl = document.getElementById('healthText');
      }
      
      initEventListeners() {
        document.getElementById('chatForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.sendMessage();
        });
        
        this.chatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });
        
        this.chatInput.addEventListener('input', () => {
          this.autoResize();
        });
      }
      
      autoResize() {
        this.chatInput.style.height = 'auto';
        this.chatInput.style.height = Math.min(this.chatInput.scrollHeight, 120) + 'px';
      }
      
      async checkHealth() {
        try {
          const response = await fetch(`${this.baseUrl}/healthz`);
          const data = await response.json();
          this.healthStatusEl.textContent = `âœ… ${data.model || 'Connected'}`;
          this.healthStatusEl.style.color = 'var(--ok)';
        } catch (error) {
          this.healthStatusEl.textContent = 'âŒ Disconnected';
          this.healthStatusEl.style.color = 'var(--bad)';
        }
      }
      
      async startConversation() {
        // Send initial greeting
        await this.sendMessage('Halo', true);
      }
      
      async sendMessage(message = null, isInitial = false) {
        const text = message || this.chatInput.value.trim();
        if (!text && !isInitial) return;
        
        if (!isInitial) {
          this.addMessage('user', text);
          this.chatInput.value = '';
          this.autoResize();
        }
        
        this.setTyping(true);
        this.sendBtn.disabled = true;
        
        try {
          const response = await fetch(`${this.baseUrl}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: text,
              session_id: this.sessionId
            })
          });
          
          const data = await response.json();
          
          if (data.session_id) {
            this.sessionId = data.session_id;
            this.sessionIdEl.textContent = this.sessionId.slice(0, 8) + '...';
          }
          
          this.addMessage('bot', data.message, data.suggestions, data);
          this.updateStatus(data);
          
        } catch (error) {
          this.addMessage('bot', 'Maaf, terjadi kesalahan koneksi. Silakan coba lagi.');
          console.error('Chat error:', error);
        }
        
        this.setTyping(false);
        this.sendBtn.disabled = false;
        this.chatInput.focus();
      }
      
      addMessage(type, content, suggestions = [], data = null) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = type === 'user' ? 'U' : 'ðŸ¤–';
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        const textEl = document.createElement('div');
        textEl.textContent = content;
        messageContent.appendChild(textEl);
        
        if (suggestions && suggestions.length > 0) {
          const suggestionsEl = document.createElement('div');
          suggestionsEl.className = 'suggestions';
          
          suggestions.forEach(suggestion => {
            const btn = document.createElement('button');
            btn.className = 'suggestion-btn';
            btn.textContent = suggestion;
            btn.onclick = () => {
              this.chatInput.value = suggestion;
              this.sendMessage();
            };
            suggestionsEl.appendChild(btn);
          });
          
          messageContent.appendChild(suggestionsEl);
        }
        
        if (type === 'bot' && data && data.collected_info) {
          const infoPanel = this.createInfoPanel(data.collected_info, data.confidence);
          messageContent.appendChild(infoPanel);
        }
        
        const timeEl = document.createElement('div');
        timeEl.className = 'message-time';
        timeEl.textContent = new Date().toLocaleTimeString('id-ID');
        messageContent.appendChild(timeEl);
        
        messageEl.appendChild(avatar);
        messageEl.appendChild(messageContent);
        
        this.chatMessages.appendChild(messageEl);
        this.scrollToBottom();
      }
      
      createInfoPanel(collectedInfo, confidence) {
        const panel = document.createElement('div');
        panel.className = 'info-panel';
        
        const title = document.createElement('h4');
        title.textContent = 'Form Complain';
        panel.appendChild(title);
        
        const fields = [
          { key: 'full_name', label: 'Nama' },
          { key: 'account_number', label: 'No Rekening' },
          { key: 'channel', label: 'Channel' },
          { key: 'category', label: 'Category' },
          { key: 'description', label: 'Deskripsi' }
        ];
        
        fields.forEach(field => {
          const item = document.createElement('div');
          item.className = 'info-item';
          const value = collectedInfo[field.key] || 'null';
          item.innerHTML = `
            <span class="label">${field.label}</span>
            <span class="value">${value}</span>
          `;
          panel.appendChild(item);
        });
        
        if (confidence !== undefined) {
          const confidenceItem = document.createElement('div');
          confidenceItem.className = 'info-item';
          confidenceItem.innerHTML = `
            <span class="label">Kelengkapan</span>
            <span class="value">${Math.round(confidence * 100)}%</span>
          `;
          panel.appendChild(confidenceItem);
        }
        
        return panel;
      }
      
      updateStatus(data) {
        if (data.confidence !== undefined) {
          this.confidenceEl.textContent = Math.round(data.confidence * 100) + '%';
        }
        
        if (data.action) {
          const statusMap = {
            'greeting': 'Menyapa',
            'asking_name': 'Menanyakan nama',
            'asking_account': 'Menanyakan rekening',
            'asking_channel': 'Menanyakan channel',
            'asking_category': 'Menanyakan kategori',
            'asking_description': 'Menanyakan deskripsi',
            'ready_for_confirmation': 'Siap konfirmasi',
            'asking_correction': 'Menanyakan koreksi',
            'completed': 'Selesai',
            'error': 'Error'
          };
          this.chatStatusEl.textContent = statusMap[data.action] || data.action;
        }
      }
      
      setTyping(isTyping) {
        this.isTyping = isTyping;
        this.typingIndicator.style.display = isTyping ? 'flex' : 'none';
        if (isTyping) {
          this.scrollToBottom();
        }
      }
      
      scrollToBottom() {
        setTimeout(() => {
          this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
        }, 100);
      }
    }
    
    // Initialize chatbot when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new ChatBot();
    });
  </script>
</body>
</html>
